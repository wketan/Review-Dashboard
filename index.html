<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reviews Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:400,500,600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRhuoRZ2Rzg-XX_O4a6lmrC7DDNhXAilEIGg9HQkvf-BL1-nRDujZ7oLfPHHFskdm-PJX9MYKnWmqtk/pub?gid=1209334848&single=true&output=csv';
      const reviewContainer = document.getElementById('reviewContainer');
      const stat7 = document.getElementById('stat7');
      const stat30 = document.getElementById('stat30');
      const stat90 = document.getElementById('stat90');

      fetch(url)
        .then(res => res.text())
        .then(text => {
          const rows = text.trim().split('\n');
          const headers = rows.shift().split(',');
          const dateIdx = headers.findIndex(h => h.toLowerCase().includes('date'));
          const customerIdx = headers.findIndex(h => h.toLowerCase().includes('customer'));
          const ratingIdx = headers.findIndex(h => h.toLowerCase().includes('rating'));
          const contentIdx = headers.findIndex(h => h.toLowerCase().includes('content'));
          const archivedIdx = headers.findIndex(h => h.toLowerCase().includes('archived'));

          let now = new Date();
          let count7 = 0, count30 = 0, count90 = 0;
          const ratingData = [0, 0, 0, 0, 0];

          rows.forEach(row => {
            const cols = row.split(',');
            const date = new Date(cols[dateIdx]);
            const rating = parseInt(cols[ratingIdx]);
            const archived = cols[archivedIdx]?.toLowerCase() === 'yes';

            const diffDays = (now - date) / (1000 * 60 * 60 * 24);
            if (!archived) {
              if (diffDays <= 7) count7++;
              if (diffDays <= 30) count30++;
              if (diffDays <= 90) count90++;
            }

            if (rating >= 1 && rating <= 5) ratingData[rating - 1]++;

            const reviewCard = document.createElement('div');
            reviewCard.className = 'review-card';
            reviewCard.innerHTML = `
              <div class="review-header">
                <span class="customer-name">${cols[customerIdx]}</span>
                <span class="review-date">${date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' })}</span>
              </div>
              <div class="review-rating">${'â˜…'.repeat(rating)}</div>
              <p class="review-content">${cols[contentIdx] || 'â€”'}</p>
            `;
            reviewContainer.appendChild(reviewCard);
          });

          stat7.textContent = count7;
          stat30.textContent = count30;
          stat90.textContent = count90;

          new Chart(document.getElementById('ratingChart'), {
            type: 'bar',
            data: {
              labels: ['â˜…', 'â˜…â˜…', 'â˜…â˜…â˜…', 'â˜…â˜…â˜…â˜…', 'â˜…â˜…â˜…â˜…â˜…'],
              datasets: [{
                label: 'Visible Ratings',
                backgroundColor: '#007aff',
                data: ratingData
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  precision: 0
                }
              }
            }
          });
        })
        .catch(err => console.error('Failed to fetch:', err));
    });
  </script>
  <style>
    body {
      margin: 0;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom right, #f6f9fc, #e3ebf6);
      color: #1c1c1e;
    }
    header {
      background: linear-gradient(to right, #007aff, #5ac8fa);
      color: white;
      padding: 24px 40px;
      font-size: 26px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container {
      max-width: 1100px;
      margin: 48px auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
      padding: 40px 32px;
    }
    .card-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 32px;
    }
    .card {
      flex: 1;
      padding: 20px;
      border-radius: 12px;
      background: linear-gradient(to right, #ffffff, #f0f4ff);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    .card h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #007aff;
    }
    .card p {
      font-size: 28px;
      margin: 0;
      font-weight: bold;
    }
    .chart-container {
      margin: 40px auto;
      width: 100%;
      max-width: 600px;
    }
    .review-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      font-weight: 500;
      margin-bottom: 8px;
    }
    .customer-name {
      font-weight: 600;
    }
    .review-date {
      color: #888;
      font-size: 14px;
    }
    .review-rating {
      color: #f7b500;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .review-content {
      margin: 0;
      font-size: 16px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <header>ðŸ“ˆ Reviews Dashboard</header>
  <div class="container">
    <div class="card-row">
      <div class="card">
        <h3>Last 7 Days</h3>
        <p id="stat7">0</p>
      </div>
      <div class="card">
        <h3>Last 30 Days</h3>
        <p id="stat30">0</p>
      </div>
      <div class="card">
        <h3>Last 90 Days</h3>
        <p id="stat90">0</p>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="ratingChart"></canvas>
    </div>

    <div id="reviewContainer"></div>
  </div>
</body>
</html>
