<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reviews Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:400,500,600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom right, #f6f9fc, #e3ebf6);
      color: #1c1c1e;
    }
    header {
      background: linear-gradient(to right, #007aff, #5ac8fa);
      color: white;
      padding: 24px 40px;
      font-size: 26px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container {
      max-width: 1100px;
      margin: 48px auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
      padding: 40px 32px;
    }
    .error {
      color: red;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f2f2f2;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>üìà Reviews Dashboard</header>
  <div class="container">
    <div id="errorContainer" class="error" style="display:none;"></div>
    <div id="loadingSpinner" style="display:none; font-size: 14px; color: #555; margin-top: 12px;">‚è≥ Loading data...</div>
    <button id="retryBtn" style="display:none;margin-top:12px;padding:8px 16px;background:#007aff;color:#fff;border:none;border-radius:6px;font-weight:500;cursor:pointer;">üîÅ Retry</button>
    <div style="margin-top:20px; font-size:14px; display:flex; gap:24px;">
      <label><input type="radio" name="archiveFilter" value="all" checked> All Reviews</label>
      <label><input type="radio" name="archiveFilter" value="unarchived"> Only Active</label>
      <label><input type="radio" name="archiveFilter" value="archived"> Only Archived</label>
    </div>
    <table id="reviewsTable" style="display:none;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Rating</th>
          <th>Content</th>
          <th>Archived</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="ratingChart" height="100" style="margin-top:32px;"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = document.getElementById('reviewsTable');
      const tbody = table.querySelector('tbody');
      const spinner = document.getElementById('loadingSpinner');
      const errorContainer = document.getElementById('errorContainer');
      const retryBtn = document.getElementById('retryBtn');
      const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRhuoRZ2Rzg-XX_O4a6lmrC7DDNhXAilEIGg9HQkvf-BL1-nRDujZ7oLfPHHFskdm-PJX9MYKnWmqtk/pub?gid=1209334848&single=true&output=csv';

      const chart = new Chart(document.getElementById('ratingChart'), {
        type: 'bar',
        data: {
          labels: ['‚òÖ', '‚òÖ‚òÖ', '‚òÖ‚òÖ‚òÖ', '‚òÖ‚òÖ‚òÖ‚òÖ', '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'],
          datasets: [{
            label: 'Visible Ratings',
            data: [0, 0, 0, 0, 0],
            backgroundColor: '#007aff'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      async function loadCSVFromGoogleSheet(url) {
        spinner.style.display = 'block';
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Network response was not ok');
          const text = await response.text();
          const parsed = Papa.parse(text, { header: true });
          tbody.innerHTML = '';
          const archiveFilter = document.querySelector('input[name="archiveFilter"]:checked').value;
          const processed = [];
          parsed.data.filter(r => r.Date).forEach(row => {
            const isArchived = row.Archived && row.Archived.trim() !== '';
            if ((archiveFilter === 'archived' && !isArchived) || (archiveFilter === 'unarchived' && isArchived)) return;
            const tr = document.createElement('tr');
            const formattedDate = new Date(row.Date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const customer = row['Customer'] || row['Customer Name'] || '‚Äî';
            const content = row['Customer Doma Content'] || row['Content'] || '‚Äî';
            tr.innerHTML = `
              <td>${formattedDate}</td>
              <td>${customer}</td>
              <td>${'‚òÖ'.repeat(+row.Rating || 0)}</td>
              <td>${content}</td>
              <td>${row.Archived || '‚Äî'}</td>
            `;
            tbody.appendChild(tr);
            processed.push(row);
          });
          updateChart(processed);
          table.style.display = 'table';
          errorContainer.style.display = 'none';
          retryBtn.style.display = 'none';
        } catch (err) {
          errorContainer.style.display = 'block';
          errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
          errorContainer.style.border = '1px solid #e00';
          errorContainer.style.background = '#ffeeee';
          errorContainer.style.padding = '12px';
          errorContainer.style.borderRadius = '8px';
          errorContainer.textContent = '‚ùå Failed to fetch Google Sheet. Please check the link and ensure it is published publicly as a CSV.';
          retryBtn.style.display = 'inline-block';
        } finally {
          spinner.style.display = 'none';
        }
      }

      function updateChart(data) {
        const ratingCounts = [0, 0, 0, 0, 0];
        const archiveFilter = document.querySelector('input[name="archiveFilter"]:checked').value;
        data.forEach(r => {
          const isArchived = r.Archived && r.Archived.trim() !== '';
          if ((archiveFilter === 'archived' && !isArchived) || (archiveFilter === 'unarchived' && isArchived)) return;
          const index = parseInt(r.Rating) - 1;
          if (!isNaN(index) && index >= 0 && index < 5) ratingCounts[index]++;
        });
        chart.data.datasets[0].data = ratingCounts;
        chart.update();
      }

      document.querySelectorAll('input[name="archiveFilter"]').forEach(el => el.addEventListener('change', () => loadCSVFromGoogleSheet(sheetURL)));

      retryBtn.addEventListener('click', () => {
        retryBtn.style.display = 'none';
        errorContainer.style.display = 'none';
        loadCSVFromGoogleSheet(sheetURL);
      });

      loadCSVFromGoogleSheet(sheetURL);
    });
  </script>
</body>
</html>
